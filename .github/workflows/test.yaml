name: test

on: push

jobs:
  test:
    name: Lint and test
    runs-on: 'ubuntu-latest'
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Install Just
        uses: extractions/setup-just@v1

      - name: Install tools
        run: just tools-install

      - name: Find tools
        run: echo "${HOME}/go/bin" >> $GITHUB_PATH

      - name: test
        run: just lint

  container:
    name: Build and upload container image
    runs-on: 'ubuntu-latest'
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Build APK
        id: melange
        uses: chainguard-dev/actions/melange-build@main
        with:
          config: melange.yaml
          archs: x86_64,aarch64
          sign-with-temporary-key: true

      - name: Build OCI
        id: apko
        uses: chainguard-dev/actions/apko-build@main
        with:
          config: apko.yaml
          archs: x86_64,aarch64
          tag: ghcr.io/mt-inside/pem2jwks:${{ github.ref_name }}
          # Default value for melange-build.signing-key-path
          keyring-append: ${{ github.workspace }}/melange.rsa

      - name: Sign OCI
        shell: bash
        run: COSIGN_EXPERIMENTAL=true cosign sign ${{ steps.apko.outputs.digest }}
